<% layout('../layout/app') -%>
<div class="product-wrap" id="products">
    <div class="font-up-bold text-uppercase" v-if="breadcrumb.category">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb cyan lighten-4">
                <li class="breadcrumb-item"><a class="" href="/">Home</a></li>
                <li class="breadcrumb-item"><a class=""
                        :href="'/category/' + categoryID">{{breadcrumb.category.name}}</a></li>
                <li class="breadcrumb-item active">{{breadcrumb.subCategory.name}}</li>
            </ol>
        </nav>
    </div>
    <div class="row" v-show="!detailMode">
        <div v-for="(item, index) in products" :key="index" class="col-3 col-sm-2 mb-2">
            <div class="card">
                <div class="view overlay">
                    <img class="card-img-top" :src="item.images[0]" height="170" alt="Card image cap">
                    <a @click.prevent="viewDetail(item, index)">
                        <div class="mask rgba-white-slight"></div>
                    </a>
                </div>
                <div class="rounded-bottom mdb-color lighten-3 text-center pt-3">
                    <ul class="list-unstyled list-inline font-small m-0">
                        <li class="list-inline-item pr-2 text-white float-left ml-3">
                            <p class="small">{{item.name}}</p>
                        </li>
                        <li class="list-inline-item float-right mr-2">
                            <p class="white-text small"><i class="fas fa-images mr-2"></i>{{item.images.length}}</p>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div v-if="products.length==0">
            <div class="ml-4">
                <h4>There are no Items</h4>
            </div>
        </div>
    </div>
    <div v-if="products.length && !detailMode" class="d-flex">
        <nav aria-label="Page navigation example" class="m-auto">
            <ul class="pagination pagination-circle pg-blue">
                <li class="page-item" :class="currentPage == 1 ? 'disabled': ''"><a class="page-link"
                        @click.prevent="setPage(1)">First</a></li>
                <li class="page-item" :class="currentPage == 1 ? 'disabled': ''">
                    <a class="page-link" aria-label="Previous" @click.prevent="setPage(currentPage - 1)">
                        <span aria-hidden="true">&laquo;</span>
                        <span class="sr-only">Previous</span>
                    </a>
                </li>
                <li class="page-item" :class="item==currentPage?'active':''" v-for="(item, index) in paginationArray"
                    :key="index"><a class="page-link" @click.prevent="setPage(item)">{{item}}</a></li>
                <li class="page-item" :class="currentPage == totalPageNum ? 'disabled': ''">
                    <a class="page-link" aria-label="Next" @click.prevent="setPage(currentPage + 1)">
                        <span aria-hidden="true">&raquo;</span>
                        <span class="sr-only">Next</span>
                    </a>
                </li>
                <li class="page-item" :class="currentPage == totalPageNum ? 'disabled': ''"><a class="page-link"
                        @click.prevent="setPage(totalPageNum)">Last</a></li>
            </ul>
        </nav>
    </div>
    <div class="modal fade" id="productEdit" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <h5 class="modal-title w-100 font-weight-bold">Edit Product</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body mx-3">
                    <form id="categoryForm" class="needs-validation" novalidate>
                        <div class="form-group">
                            <label for="albumName">Album Name</label>
                            <input type="text" class="form-control" id="albumName" v-model="detailData.name"
                                placeholder="Album Name">
                        </div>
                        <div class="form-group shadow-textarea">
                            <label for="productDescription">Description</label>
                            <textarea class="form-control z-depth-1" id="productDescription" rows="8"
                                placeholder="Write something here..." v-model="detailData.description"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button class="btn btn-default btn-rounded" @click.prevent="saveChanges()">Save</button>
                </div>
            </div>
        </div>
    </div>
    <div class="detail-section" v-show="detailMode" v-if="detailMode">
        <div class="row">
            <button class="btn btn-primary ml-auto btn-rounded" @click.prevent="viewProducts()">Go back</button>
        </div>
        <div class="row">
            <div class="col-2">
                <img :src="detailData.images[0]" alt="thumbnail" width="100%">
            </div>
            <div class="col-10">
                <h3>{{detailData.name}} | {{detailData.images.length}}</h3>
                <p>{{detailData.description}}</p>
                <div class="d-flex">
                    <div>
                        <a href="javascript:void(0)" class="btn btn-purple btn-rounded" data-toggle="modal"
                            data-target="#productEdit">Edit</a>
                    </div>
                    <div class="btn-group ml-auto" role="group" aria-label="options">
                        <button type="button" class="btn btn-purple btn-rounded" @click.prevent="changeView('col-2')"><i
                                class="fas fa-icons pr-2"></i>
                            Small</button>
                        <button type="button" class="btn btn-purple btn-rounded" @click.prevent="changeView('col-3')"><i
                                class="far fa-images pr-2"></i>Detail</button>
                        <button type="button" class="btn btn-purple btn-rounded"
                            @click.prevent="changeView('col-12')"><i class="far fa-image pr-2"></i></i>Big</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-5 gallery">
            <div :class="viewMode" v-for="(item, index) in detailData.images" :key="index">
                <a :href="item">
                    <img :src="item" alt="image" width="100%" class="p-2">
                </a>
                <div v-if="viewMode != 'col-2'">
                    <p class="detail-name pl-2 m-0">{{item.split('/')[item.split('/').length-1]}}</p>
                    <p class="detail-date pl-2 m-0">{{changeDateformat(detailData.created_at)}}</p>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    new Vue({
        el: "#products",
        data() {
            return {
                breadcrumb: [],
                products: [],
                detailData: {},
                detailMode: false,
                viewMode: 'col-3',
                currentPage: 1,
                productsCount: 0,
                totalPageNum: 0,
                paginationArray: [],
                categoryID: '',
                subCategoryID: '',
                loader: {},
                index: 0,
                error:''
            }
        },
        methods: {
            saveChanges() {
                this.products[this.index] = this.detailData;
                this.openLoader();
                let { name, description, _id } = this.detailData;
                $.ajax({
                    method: "POST",
                    url: "/editProduct",
                    data: {
                        name, description, _id
                    }
                }).done(res => {
                    this.loader.hide();
                    if (res.status) {
                        $('#productEdit').modal('hide')
                    } else {
                        this.error = 'Something went wrong'
                    }
                })
            },
            openLoader() {
                this.loader = this.$loading.show({
                    loader: 'dots',
                    backgroundColor: '#ffffff',
                    opacity: 0.5,
                    transparence: 0.5
                });
            },
            getProducts(page) {
                this.openLoader()
                $.ajax({
                    method: "POST",
                    url: `/getProducts`,
                    data: {
                        categoryID: this.categoryID,
                        subCategoryID: this.subCategoryID,
                        page,
                    }
                }).done(res => {
                    if (res.status) {
                        if (res.breadcrumb) this.breadcrumb = res.breadcrumb
                        this.products = res.data;
                        if (res.productsCount) {
                            this.productsCount = res.productsCount;
                            let reminder = this.productsCount % 24 == 0 ? 0 : 1;
                            this.totalPageNum = Math.floor(this.productsCount / 24) + reminder
                        };
                        this.getPaginationArray(page);
                        this.loader.hide()
                    }
                })
            },
            viewDetail(item, index) {
                this.index = index;
                this.detailData = item;
                this.detailMode = true;
                setTimeout(() => {
                    $(".gallery").magnificPopup({
                        delegate: "a",
                        type: "image",
                        tLoading: "Loading image #%curr%...",
                        mainClass: "mfp-img-mobile",
                        gallery: {
                            enabled: true,
                            navigateByImgClick: true,
                            preload: [0, 1] // Will preload 0 - before current, and 1 after the current image
                        },
                        image: {
                            tError: '<a href="%url%">The image #%curr%</a> could not be loaded.'
                        }
                    });
                }, 50);
            },
            setPage(page) {
                this.getPaginationArray(page);
                this.getProducts(page)
            },
            getPaginationArray(page) {
                this.currentPage = page
                this.paginationArray = []
                if (page < 4) {
                    for (let i = 1; i <= this.totalPageNum; i++) {
                        this.paginationArray.push(i);
                        if (this.paginationArray.length == 5) break;
                    }
                    return
                }
                if (page > this.totalPageNum - 4) {
                    for (let i = this.totalPageNum - 4; i <= this.totalPageNum; i++) {
                        this.paginationArray.push(i)
                    }
                    return
                }
                for (let i = page - 2; i <= page + 2; i++) {
                    this.paginationArray.push(i)
                }
            },
            viewProducts() {
                this.detailMode = false;
            },
            changeView(mode) {
                this.viewMode = mode
            },
            changeDateformat(timestamp) {
                let date = new Date(timestamp)
                return date.toLocaleString();
            }
        },
        mounted() {
            let param = new URL(window.location.href).pathname
            param = param.split('/subCategory/')
            this.categoryID = param[0].split('category/')[1];
            this.subCategoryID = param[1]
            setTimeout(() => {
                this.getProducts(1);
            }, 200);
        },
    })
</script>